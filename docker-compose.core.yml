version: '3.9'

# Core services only (Discovery, Config, Gateway)
# Run infrastructure first: docker-compose -f docker-compose.infrastructure.yml up -d

services:
  discovery-server:
    build:
      context: .
      dockerfile: services/discovery/Dockerfile
    container_name: shopsphere-discovery
    ports:
      - "8761:8761"
    networks:
      - shopsphere-network
    environment:
      EUREKA_HOST: discovery-server
      EUREKA_PORT: 8761
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8761/actuator/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 40s

  config-server:
    build:
      context: .
      dockerfile: services/config-server/Dockerfile
    container_name: shopsphere-config
    depends_on:
      discovery-server:
        condition: service_healthy
    ports:
      - "8888:8888"
    networks:
      - shopsphere-network
    environment:
      EUREKA_HOST: discovery-server
      EUREKA_PORT: 8761

  api-gateway:
    build:
      context: .
      dockerfile: services/api-gateway/Dockerfile
    container_name: shopsphere-gateway
    depends_on:
      discovery-server:
        condition: service_healthy
      config-server:
        condition: service_started
    ports:
      - "8080:8080"
    networks:
      - shopsphere-network
    environment:
      EUREKA_HOST: discovery-server
      EUREKA_PORT: 8761

networks:
  shopsphere-network:
    external: true
